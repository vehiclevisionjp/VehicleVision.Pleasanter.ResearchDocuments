# 通知カスタムフォーマット・プレースホルダの仕組み

プリザンターの通知機能におけるカスタムフォーマット（`UseCustomFormat`）とプレースホルダ（`[ColumnName]`）の定義・解析・置換ロジックを調査する。

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [調査情報](#調査情報)
- [調査目的](#調査目的)
- [概要](#概要)
- [通知設定クラスの構造](#通知設定クラスの構造)
    - [`GetFormat` メソッド](#getformat-メソッド)
    - [`GetDefaultFormat` メソッド](#getdefaultformat-メソッド)
- [NotificationColumnFormat クラス](#notificationcolumnformat-クラス)
    - [コンストラクタ](#コンストラクタ)
    - [`DisplayText` メソッド（表示テキスト生成）](#displaytext-メソッド表示テキスト生成)
    - [ValueDisplayTypes 列挙](#valuedisplaytypes-列挙)
- [通知本文の組み立て処理（NoticeBody メソッド）](#通知本文の組み立て処理noticebody-メソッド)
    - [処理フロー](#処理フロー)
    - [コード抜粋](#コード抜粋)
- [プレースホルダの解析（IncludedColumns メソッド）](#プレースホルダの解析includedcolumns-メソッド)
    - [正規表現パターン](#正規表現パターン)
- [件名（Subject）のプレースホルダ置換](#件名subjectのプレースホルダ置換)
    - [`ReplacedDisplayValues` メソッド](#replaceddisplayvalues-メソッド)
    - [`[NotificationTrigger]` 特殊プレースホルダ](#notificationtrigger-特殊プレースホルダ)
- [コンテキスト変数の置換](#コンテキスト変数の置換)
    - [`ReplacedContextValues` メソッド](#replacedcontextvalues-メソッド)
- [ToNotice 拡張メソッド](#tonotice-拡張メソッド)
    - [string 型の ToNotice（選択肢カラムの場合）](#string-型の-tonotice選択肢カラムの場合)
- [宛先アドレスのプレースホルダ](#宛先アドレスのプレースホルダ)
- [ラベルテキスト ↔ カラム名の変換](#ラベルテキスト--カラム名の変換)
- [リンクカラム形式 `[ClassA~1234,ClassB]` のサポート状況](#リンクカラム形式-classa1234classb-のサポート状況)
    - [結論: 通知プレースホルダではサポートされない](#結論-通知プレースホルダではサポートされない)
    - [理由](#理由)
    - [チルダ構文の本来の用途](#チルダ構文の本来の用途)
    - [グリッドデザインとの比較](#グリッドデザインとの比較)
    - [通知で選択肢の表示テキストを得る方法](#通知で選択肢の表示テキストを得る方法)
- [利用可能なプレースホルダ一覧](#利用可能なプレースホルダ一覧)
    - [フォーマット本文で指定可能な JSON プロパティ](#フォーマット本文で指定可能な-json-プロパティ)
    - [フォーマット本文（`Name` フィールドで指定可能なカラム名）](#フォーマット本文name-フィールドで指定可能なカラム名)
    - [コンテキスト変数（波括弧）](#コンテキスト変数波括弧)
    - [件名専用](#件名専用)
- [結論](#結論)
- [関連ソースコード](#関連ソースコード)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 調査情報

| 調査日        | リポジトリ | ブランチ           | タグ/バージョン | コミット     | 備考     |
| ------------- | ---------- | ------------------ | --------------- | ------------ | -------- |
| 2026年2月18日 | Pleasanter | Pleasanter_1.5.1.0 |                 | `34f162a439` | 初回調査 |

## 調査目的

通知のカスタムフォーマットにおいて、`[ColumnName]` 形式のプレースホルダがどのように定義・解析・置換されるかを把握する。特に、リンクカラム形式（`[ClassA~1234,ClassB]` のようなチルダ構文）が通知プレースホルダで利用可能かを明らかにする。

---

## 概要

プリザンターの通知には 2 種類のプレースホルダ体系がある。

| 区分             | 使用箇所   | プレースホルダ形式                    | 概要                                                                               |
| ---------------- | ---------- | ------------------------------------- | ---------------------------------------------------------------------------------- |
| 本文（Format）   | 通知本文   | JSON 行（`NotificationColumnFormat`） | 各行が `NotificationColumnFormat` の JSON としてデシリアライズされ、カラム値に変換 |
| 件名（Subject）  | 通知件名   | `[ColumnName]`                        | `ReplacedDisplayValues` で `[カラム名]` → 表示値に置換                             |
| コンテキスト変数 | 本文・件名 | `{Url}`, `{UserName}` 等              | `ReplacedContextValues` で固定変数を置換                                           |

---

## 通知設定クラスの構造

**ファイル**: `Implem.Pleasanter/Libraries/Settings/Notification.cs`

```csharp
public class Notification : ISettingListItem
{
    public bool? UseCustomFormat;   // カスタムフォーマット有効化フラグ
    public string Format;           // カスタムフォーマット文字列（改行区切り）
    public string Subject;          // 通知件名（プレースホルダ使用可）
    public string Body;             // 通知本文（プロセス通知用）
    public List<string> MonitorChangesColumns; // 監視対象カラム
    // ...
}
```

### `GetFormat` メソッド

**ファイル**: `Implem.Pleasanter/Libraries/Settings/Notification.cs`（行番号: 556-560）

```csharp
public string GetFormat(Context context, SiteSettings ss)
{
    return Strings.CoalesceEmpty(Format, GetDefaultFormat(
        context: context,
        ss: ss));
}
```

カスタムフォーマットが空の場合、`GetDefaultFormat` でデフォルトフォーマットが生成される。

### `GetDefaultFormat` メソッド

**ファイル**: `Implem.Pleasanter/Libraries/Settings/Notification.cs`（行番号: 562-570）

```csharp
public string GetDefaultFormat(Context context, SiteSettings ss)
{
    return "{Url}\n"
        + ColumnCollection(
            context: context,
            ss: ss,
            update: true)
                .Select(o => new NotificationColumnFormat(
                    columnName: o.ColumnName).ToJson())
                .Join("\n")
        + "\n\n{UserName}<{MailAddress}>";
}
```

デフォルトフォーマットは以下の構造:

```text
{Url}
{"Name":"[Title]"}
{"Name":"[Body]"}
{"Name":"[Status]"}
...（監視対象カラムごとに1行のJSON）
{UserName}<{MailAddress}>
```

---

## NotificationColumnFormat クラス

**ファイル**: `Implem.Pleasanter/Libraries/Settings/NotificationColumnFormat.cs`

各行は `NotificationColumnFormat` の JSON 形式でシリアライズされる。

```csharp
public class NotificationColumnFormat
{
    public string Name;              // プレースホルダ名（例: "[Title]", "[ClassA]"）
    public string Prefix;            // ラベル前のプレフィックス
    public string Delimiter;         // ラベルと値の区切り文字（デフォルト: " : "）
    public string Allow;             // 変更前後の区切り文字（デフォルト: " => "）
    public string DiffTypes;         // 差分表示方式（"standard" or "DiffMatchPatch"）
    public string StartBracket;      // 差分表示の開始括弧
    public string EndBracket;        // 差分表示の終了括弧
    public string DeletePrefixSymbol; // 削除部分のプレフィックス記号
    public string DeleteSuffixSymbol; // 削除部分のサフィックス記号
    public string AddPrefixSymbol;   // 追加部分のプレフィックス記号
    public string AddSuffixSymbol;   // 追加部分のサフィックス記号
    public bool? Always;             // 更新されていなくても常に表示
    public ValueDisplayTypes? DisplayTypes; // 表示タイプ（変更前後/変更前のみ/変更後のみ）
    public bool? ValueOnly;          // 値のみ表示（ヘッダ非表示）
    public bool? ConsiderMultiLine;  // 複数行を考慮した表示
}
```

### コンストラクタ

```csharp
public NotificationColumnFormat(string columnName)
{
    Name = $"[{columnName}]";  // "[ClassA]" のように [] で囲む
}
```

### `DisplayText` メソッド（表示テキスト生成）

```csharp
public string DisplayText(string self, string saved, Column column, bool updated, bool update)
{
    return update
        ? updated
            ? !saved.IsNullOrEmpty()
                ? GetColumnDisplayText(column, saved, self)  // 変更あり
                : $"{Header(column)}{Self(self)}"            // 新規値
            : Always == true
                ? $"{Header(column)}{Self(self)}"            // 常に表示
                : string.Empty                               // 変更なし→空
        : $"{Header(column)}{Self(self)}";                   // 作成時
}
```

### ValueDisplayTypes 列挙

| 値  | 名前                   | 説明                                     |
| --- | ---------------------- | ---------------------------------------- |
| 0   | `BeforeAndAfterChange` | 変更前と変更後の両方を表示（デフォルト） |
| 1   | `BeforeChange`         | 変更前のみ                               |
| 2   | `AfterChange`          | 変更後のみ                               |

---

## 通知本文の組み立て処理（NoticeBody メソッド）

**ファイル**: `Implem.Pleasanter/Models/Results/ResultModel.cs`（行番号: 4030-4200）

### 処理フロー

```mermaid
flowchart TD
    A[notification.GetFormat で<br/>フォーマット文字列取得] --> B[改行で分割]
    B --> C{各行をループ}
    C --> D[行を Trim]
    D --> E[JSON デシリアライズ<br/>→ NotificationColumnFormat]
    E --> F{Format.Name で<br/>カラムを特定}
    F -->|カラムが見つからない| G[ReplacedContextValues<br/>でコンテキスト変数を置換]
    F -->|カラムが見つかった| H{カラム名で分岐}
    H -->|Title| I[Title.ToNotice]
    H -->|Body| J[Body.ToNotice]
    H -->|Status| K[Status.ToNotice]
    H -->|ClassA 等| L[GetClass.ToNotice]
    H -->|NumA 等| M[GetNum.ToNotice]
    H -->|DateA 等| N[GetDate.ToNotice]
    H -->|...| O[各型の ToNotice]
    G --> P[body に追加]
    I --> P
    J --> P
    K --> P
    L --> P
    M --> P
    N --> P
    O --> P
    P --> C
```

### コード抜粋

```csharp
private string NoticeBody(
    Context context, SiteSettings ss,
    Notification notification, bool update = false)
{
    var body = new System.Text.StringBuilder();
    notification.GetFormat(context: context, ss: ss)
        .Split('\n')
        .Select(line => new
        {
            Line = line.Trim(),
            Format = line.Trim().Deserialize<NotificationColumnFormat>()
        })
        .ForEach(data =>
        {
            var column = ss.IncludedColumns(data.Format?.Name)?.FirstOrDefault();
            if (column == null)
            {
                // JSON ではない行 → コンテキスト変数として置換
                body.Append(ReplacedContextValues(context: context, value: data.Line));
                body.Append("\n");
            }
            else
            {
                // カラム名に対応する値を ToNotice で変換
                switch (column.Name)
                {
                    case "Title":
                        body.Append(Title.ToNotice(...));
                        break;
                    case "Body":
                        body.Append(Body.ToNotice(...));
                        break;
                    // ... 各カラムに対応する分岐
                    default:
                        switch (Def.ExtendedColumnTypes.Get(column?.Name ?? string.Empty))
                        {
                            case "Class":
                                body.Append(GetClass(columnName: column.Name).ToNotice(...));
                                break;
                            case "Num":
                                body.Append(GetNum(columnName: column.Name).ToNotice(...));
                                break;
                            // ... Date, Description, Check, Attachments
                        }
                        break;
                }
            }
        });
    return body.ToString();
}
```

---

## プレースホルダの解析（IncludedColumns メソッド）

**ファイル**: `Implem.Pleasanter/Libraries/Settings/SiteSettings.cs`（行番号: 4428-4460）

`[...]` で囲まれたカラム名を正規表現で抽出する中核メソッド。

```csharp
public List<Column> IncludedColumns(string value, bool labelText = false)
{
    var columns = new List<Column>();
    if (!value.IsNullOrEmpty())
    {
        foreach (Match match in value.RegexMatches(@"(?<=\[).+?(?=\])"))
        {
            var isValue = false;
            var columnName = match.Value;
            if (!labelText && columnName.StartsWith("@"))
            {
                isValue = true;
                columnName = columnName.Substring(1);
            }
            var column = labelText
                ? Columns.FirstOrDefault(o => o.LabelText == columnName)
                : Columns.FirstOrDefault(o => o.ColumnName == columnName);
            if (column != null)
            {
                column.OutputType = isValue
                    ? Column.OutputTypes.Value
                    : Column.OutputTypes.DisplayValue;
                columns.Add(column);
            }
        }
    }
    return columns.DistinctBy(column => column.ColumnName).ToList();
}
```

### 正規表現パターン

```regex
(?<=\[).+?(?=\])
```

| パターン要素 | 意味                              |
| ------------ | --------------------------------- |
| `(?<=\[)`    | `[` の直後（肯定後読み）          |
| `.+?`        | 1文字以上の任意文字（最短マッチ） |
| `(?=\])`     | `]` の直前（肯定先読み）          |

**重要**: この正規表現は `[` と `]` の間のテキストをカラム名として抽出するが、`Columns.FirstOrDefault(o => o.ColumnName == columnName)` でカラム名の完全一致を要求する。

**`@` プレフィックスについて**:
`IncludedColumns` は `[@ColumnName]` のように `@` を先頭に付けた形式も認識し、
`@` を除去してカラム名を検索する。
この場合 `column.OutputType` が `Column.OutputTypes.Value`（値出力）に設定される。
ただし、通知の件名置換（`ReplacedDisplayValues`）では
`value.Replace($"[{column.ColumnName}]", ...)` で置換するため、
元の文字列中の `[@ClassA]` は `[ClassA]` と一致せず**置換されない**。
このため、`@` プレフィックスは通知プレースホルダでは実質的に機能しない。
グリッドのカスタムデザインでも同様の制約がある。

---

## 件名（Subject）のプレースホルダ置換

**ファイル**: `Implem.Pleasanter/Models/Results/ResultModel.cs`（行番号: 3808-3822）

### `ReplacedDisplayValues` メソッド

```csharp
public string ReplacedDisplayValues(Context context, SiteSettings ss, string value)
{
    ss.IncludedColumns(value: value).ForEach(column =>
        value = value.Replace(
            $"[{column.ColumnName}]",
            ToDisplay(context: context, ss: ss, column: column,
                mine: Mine(context: context))));
    value = ReplacedContextValues(context, value);
    return value;
}
```

件名では `[ColumnName]` がそのカラムの表示値に直接置換される。

### `[NotificationTrigger]` 特殊プレースホルダ

件名で使用できる特殊プレースホルダ。通知トリガーの種類に応じて置換される。

```csharp
// Created の場合
notification.Subject.Replace("[NotificationTrigger]", Displays.CreatedWord(context: context))
// Updated の場合
notification.Subject.Replace("[NotificationTrigger]", Displays.UpdatedWord(context: context))
// Deleted の場合
notification.Subject.Replace("[NotificationTrigger]", Displays.DeletedWord(context: context))
```

---

## コンテキスト変数の置換

**ファイル**: `Implem.Pleasanter/Models/Results/ResultModel.cs`（行番号: 3825-3841）

### `ReplacedContextValues` メソッド

```csharp
private string ReplacedContextValues(Context context, string value)
{
    var url = Locations.ItemEditAbsoluteUri(context: context, id: ResultId);
    var mailAddress = MailAddressUtilities.Get(context: context, userId: context.UserId);
    value = value
        .Replace("{Url}", url)
        .Replace("{LoginId}", context.User.LoginId)
        .Replace("{UserName}", context.User.Name)
        .Replace("{MailAddress}", mailAddress);
    return value;
}
```

| 変数            | 置換内容                   |
| --------------- | -------------------------- |
| `{Url}`         | レコードの編集画面 URL     |
| `{LoginId}`     | 操作ユーザのログイン ID    |
| `{UserName}`    | 操作ユーザの表示名         |
| `{MailAddress}` | 操作ユーザのメールアドレス |

---

## ToNotice 拡張メソッド

**ファイル**: `Implem.Pleasanter/Libraries/Extensions/ToNoticeExtensions.cs`

各データ型に対応する `ToNotice` 拡張メソッドが定義されている。

| 対象型        | メソッドシグネチャ                     | 備考                                                   |
| ------------- | -------------------------------------- | ------------------------------------------------------ |
| `bool`        | `ToNotice(this bool self, ...)`        | チェックボックス列                                     |
| `int`         | `ToNotice(this int self, ...)`         | 整数列                                                 |
| `long`        | `ToNotice(this long self, ...)`        | 長整数列                                               |
| `DateTime`    | `ToNotice(this DateTime self, ...)`    | 日付列（ローカル時間変換あり）                         |
| `string`      | `ToNotice(this string self, ...)`      | クラス・テキスト列（**選択肢の表示テキスト変換あり**） |
| `Attachments` | `ToNotice(this Attachments self, ...)` | 添付ファイル列                                         |

### string 型の ToNotice（選択肢カラムの場合）

```csharp
public static string ToNotice(
    this string self, Context context, string saved,
    Column column, NotificationColumnFormat notificationColumnFormat,
    bool updated, bool update)
{
    if (column.HasChoices())
    {
        var selfChoiceParts = column.ChoiceParts(
            context: context, selectedValues: self, type: ExportColumn.Types.Text);
        var savedChoiceParts = column.ChoiceParts(
            context: context, selectedValues: saved, type: ExportColumn.Types.Text);
        return notificationColumnFormat.DisplayText(
            self: column.MultipleSelections == true
                ? selfChoiceParts.Join(", ")
                : selfChoiceParts.FirstOrDefault(),
            saved: ...,
            column: column, updated: updated, update: update);
    }
    // ...
}
```

選択肢カラム（Class 列がリンクカラムの場合を含む）では `ChoiceParts` を通じて値 → 表示テキストに変換される。

---

## 宛先アドレスのプレースホルダ

**ファイル**: `Implem.Pleasanter/Libraries/Settings/Notification.cs`（行番号: 247-273）

通知メールの宛先でもプレースホルダが使用可能。

```csharp
valuesTo?.ForEach(data => addresses = addresses.Replace(
    $"[{data.Key.ColumnName}]",
    ReplacedAddress(context: context, column: data.Key, value: data.Value, create: create)));
```

| プレースホルダ   | 説明                                                                             |
| ---------------- | -------------------------------------------------------------------------------- |
| `[ColumnName]`   | 該当カラムの値からメールアドレスを解決（例: `[Manager]`, `[Owner]`, `[ClassA]`） |
| `[RelatedUsers]` | 関連ユーザ（Manager・Owner・Creator・Updator）全員のメールアドレス               |

宛先フィールドに `[Manager]` や `[Owner]` を記述すると、
`ss.IncludedColumns(notification.Address)` でカラムを検出し、
そのカラムの値（ユーザ ID）からメールアドレスを
`ReplacedAddress` メソッドで解決する。
選択肢カラム（ClassA 等）にユーザが含まれている場合も同様に使用可能。

---

## ラベルテキスト ↔ カラム名の変換

**ファイル**: `Implem.Pleasanter/Libraries/Settings/SiteSettings.cs`（行番号: 4391-4415）

UI 上ではユーザにラベルテキスト（日本語名等）を表示し、内部ではカラム名で保存する。

```csharp
// ラベルテキスト → カラム名（保存時）
public string LabelTextToColumnName(string text)
{
    IncludedColumns(text, labelText: true).ForEach(column =>
        text = text.Replace($"[{column.LabelText}]", $"[{column.ColumnName}]"));
    return text;
}

// カラム名 → ラベルテキスト（表示時）
public string ColumnNameToLabelText(string text)
{
    IncludedColumns(text).ForEach(column =>
        text = text.Replace($"[{column.ColumnName}]", $"[{column.LabelText}]"));
    return text;
}
```

---

## リンクカラム形式 `[ClassA~1234,ClassB]` のサポート状況

### 結論: 通知プレースホルダではサポートされない

`[ClassA~1234,ClassB]` のようなチルダ構文は、通知のプレースホルダとしては**サポートされていない**。

### 理由

1. **`IncludedColumns` の正規表現**:
   `(?<=\[).+?(?=\])` で抽出されるテキストは
   `ClassA~1234,ClassB` となる
2. **カラム名の完全一致**:
   `Columns.FirstOrDefault(o => o.ColumnName == columnName)` で検索するため、
   `ClassA~1234,ClassB` という文字列はどのカラム名にも一致しない
3. **チルダ構文の解析ロジックが存在しない**:
   `IncludedColumns` メソッドにチルダ（`~`）やカンマ（`,`）を
   解析するロジックは実装されていない

### チルダ構文の本来の用途

チルダ構文 `ClassA~1234,ClassB` はプリザンターのテーブル結合（JOIN）を表す記法である。

| 記法                 | 意味                                                   |
| -------------------- | ------------------------------------------------------ |
| `ClassA~1234`        | ClassA カラムで SiteId=1234 のテーブルへのリンクパス   |
| `ClassA~1234,ClassB` | リンク先テーブルの ClassB カラムを参照（カンマ区切り） |
| `ClassA~1234,Title`  | リンク先テーブルのタイトルを参照                       |

この形式は `SiteSettings.GetColumn()` メソッドで処理され、
`columnName.Contains(',')` を検出して `AddJoinedColumn` を呼び出す。
しかし、`IncludedColumns` メソッドは `GetColumn` ではなく
`Columns.FirstOrDefault()` で直接検索するため、
JOIN を介した列解決が行われない。

### グリッドデザインとの比較

グリッドデザインのプレースホルダ置換ロジック
（`ResultUtilities.cs` の
`gridDesign.Replace("[" + column.ColumnName + "]", value)`）
も同じ `IncludedColumns` を使用しており、
チルダ構文を独自に解析する処理はない。ただし、グリッドの一覧表示では `GetGridColumns` → `GetColumn` の経路でテーブル結合カラムが `Columns` リストに追加済みとなるため、カスタムデザインで機能する場合がある。通知処理ではこの事前解決が行われない。

### 通知で選択肢の表示テキストを得る方法

通知フォーマットでは、リンクカラム（例: `ClassA`）に対して
`[ClassA]` と記述すると、`ToNotice` 拡張メソッド内で
`column.HasChoices()` が `true` の場合に `ChoiceParts` を経由して
選択肢の表示テキスト（`Text` プロパティ）が自動的に使用される。
つまり、**チルダ構文を使わなくても、リンクカラムの表示テキストは自動的に変換される**。

---

## 利用可能なプレースホルダ一覧

### フォーマット本文で指定可能な JSON プロパティ

カスタムフォーマットの各行は `NotificationColumnFormat` の JSON として記述する。

| プロパティ           | 型     | デフォルト | 説明                                                |
| -------------------- | ------ | ---------- | --------------------------------------------------- |
| `Name`               | string | ―          | `[ColumnName]` 形式のプレースホルダ名（必須）       |
| `Prefix`             | string | `""`       | ラベル前のプレフィックス                            |
| `Delimiter`          | string | `" : "`    | ラベルと値の区切り文字                              |
| `Allow`              | string | `" => "`   | 変更前後の区切り文字                                |
| `DiffTypes`          | string | `standard` | 差分表示方式（`standard` or `DiffMatchPatch`）      |
| `StartBracket`       | string | `(`        | DiffMatchPatch 差分の開始括弧                       |
| `EndBracket`         | string | `)`        | DiffMatchPatch 差分の終了括弧                       |
| `DeletePrefixSymbol` | string | `-`        | 削除部分のプレフィックス記号                        |
| `DeleteSuffixSymbol` | string | `""`       | 削除部分のサフィックス記号                          |
| `AddPrefixSymbol`    | string | `+`        | 追加部分のプレフィックス記号                        |
| `AddSuffixSymbol`    | string | `""`       | 追加部分のサフィックス記号                          |
| `Always`             | bool?  | `null`     | `true` の場合、更新されていなくても常に本文に含める |
| `DisplayTypes`       | int?   | `null`     | `0`: 変更前後、`1`: 変更前のみ、`2`: 変更後のみ     |
| `ValueOnly`          | bool?  | `null`     | `true` の場合、ヘッダ（ラベル名）を非表示にする     |
| `ConsiderMultiLine`  | bool?  | `null`     | `false` にすると MarkDown カラムの改行を抑制する    |

**記述例**:

```json
{"Name":"[Title]","Delimiter":": ","Always":true,"ValueOnly":true}
{"Name":"[Status]","DisplayTypes":2}
{"Name":"[Body]","DiffTypes":"DiffMatchPatch","StartBracket":"【","EndBracket":"】","DeletePrefixSymbol":"削除:","AddPrefixSymbol":"追加:"}
```

### フォーマット本文（`Name` フィールドで指定可能なカラム名）

| カテゴリ                  | プレースホルダ例                     | 説明                                   |
| ------------------------- | ------------------------------------ | -------------------------------------- |
| 固定カラム（共通）        | `[Title]`, `[Body]`, `[Status]`      | タイトル、本文、ステータス             |
| 固定カラム（共通）        | `[Manager]`, `[Owner]`               | 担当者、管理者                         |
| 固定カラム（共通）        | `[Locked]`, `[Comments]`             | ロック状態、コメント                   |
| 固定カラム（共通）        | `[Creator]`, `[Updator]`             | 作成者、更新者                         |
| 固定カラム（Issues 専用） | `[StartTime]`, `[CompletionTime]`    | 開始日、完了日（期限付きテーブルのみ） |
| 固定カラム（Issues 専用） | `[WorkValue]`, `[ProgressRate]`      | 作業量、進捗率（期限付きテーブルのみ） |
| 拡張カラム（Class）       | `[ClassA]` 〜 `[ClassZ]`             | 分類列                                 |
| 拡張カラム（Num）         | `[NumA]` 〜 `[NumZ]`                 | 数値列                                 |
| 拡張カラム（Date）        | `[DateA]` 〜 `[DateZ]`               | 日付列                                 |
| 拡張カラム（Description） | `[DescriptionA]` 〜 `[DescriptionZ]` | 説明列                                 |
| 拡張カラム（Check）       | `[CheckA]` 〜 `[CheckZ]`             | チェック列                             |
| 拡張カラム（Attachments） | `[AttachmentsA]` 〜 `[AttachmentsZ]` | 添付ファイル列                         |

### コンテキスト変数（波括弧）

| 変数            | 説明                       |
| --------------- | -------------------------- |
| `{Url}`         | レコード編集画面の URL     |
| `{LoginId}`     | 操作ユーザのログイン ID    |
| `{UserName}`    | 操作ユーザの表示名         |
| `{MailAddress}` | 操作ユーザのメールアドレス |

### 件名専用

| プレースホルダ          | 説明                                               |
| ----------------------- | -------------------------------------------------- |
| `[NotificationTrigger]` | 通知トリガー種別（作成/更新/削除）                 |
| `[カラム名]`            | 各カラムの表示値（`ReplacedDisplayValues` で置換） |

---

## 結論

| 項目                              | 結論                                                                                                            |
| --------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| プレースホルダの定義方法          | `NotificationColumnFormat` の JSON 行として `{"Name":"[ColumnName]"}` 形式で定義                                |
| プレースホルダの解析              | `IncludedColumns` メソッドが正規表現 `(?<=\[).+?(?=\])` で `[]` 内を抽出し、カラム名完全一致で検索              |
| 置換の実行                        | 本文は `NoticeBody` メソッド内で `ToNotice` 拡張メソッドにより値変換、件名は `ReplacedDisplayValues` で直接置換 |
| コンテキスト変数                  | `{Url}`, `{LoginId}`, `{UserName}`, `{MailAddress}` が `ReplacedContextValues` で置換                           |
| チルダ構文 `[ClassA~1234,ClassB]` | **通知プレースホルダではサポートされない**。`IncludedColumns` がカラム名完全一致で検索するため                  |
| リンクカラムの表示テキスト        | `[ClassA]` と記述するだけで `ToNotice` が `ChoiceParts` 経由で表示テキストに自動変換する                        |
| カスタムフォーマットの切り替え    | `UseCustomFormat = true` で有効化、`Format` フィールドにカスタムフォーマットを格納                              |

---

## 関連ソースコード

| ファイル                                                           | 概要                                                                |
| ------------------------------------------------------------------ | ------------------------------------------------------------------- |
| `Implem.Pleasanter/Libraries/Settings/Notification.cs`             | 通知設定クラス・`GetFormat`・`GetDefaultFormat`・`Send`             |
| `Implem.Pleasanter/Libraries/Settings/NotificationColumnFormat.cs` | 通知カラムフォーマットクラス・`DisplayText`                         |
| `Implem.Pleasanter/Libraries/Settings/SiteSettings.cs`             | `IncludedColumns`・`LabelTextToColumnName`・`ColumnNameToLabelText` |
| `Implem.Pleasanter/Libraries/Extensions/ToNoticeExtensions.cs`     | 各型の `ToNotice` 拡張メソッド                                      |
| `Implem.Pleasanter/Models/Results/ResultModel.cs`                  | `NoticeBody`・`ReplacedDisplayValues`・`ReplacedContextValues`      |
| `Implem.Pleasanter/Models/Issues/IssueModel.cs`                    | Issues 用の `NoticeBody`（Results と同構造）                        |
| `Implem.Pleasanter/Models/Wikis/WikiModel.cs`                      | Wiki 用の `NoticeBody`（Results と同構造）                          |
| `Implem.Pleasanter/Libraries/Settings/NotificationUtilities.cs`    | 通知種別のユーティリティ                                            |
