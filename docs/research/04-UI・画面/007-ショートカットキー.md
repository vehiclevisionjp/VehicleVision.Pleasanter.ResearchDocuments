# ショートカットキー

プリザンターで使用可能なショートカットキーの実装と、カスタマイズ方法について調査した結果をまとめる。

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [調査情報](#調査情報)
- [調査目的](#調査目的)
- [ショートカットキーの実装方式](#ショートカットキーの実装方式)
    - [HTML accesskey 属性の使用](#html-accesskey-属性の使用)
    - [HtmlAttributes.AccessKey メソッド](#htmlattributesaccesskey-メソッド)
    - [ブラウザでのショートカットキー使用方法](#ブラウザでのショートカットキー使用方法)
- [使用可能なショートカットキー一覧](#使用可能なショートカットキー一覧)
    - [コマンドボタン](#コマンドボタン)
    - [ナビゲーションボタン](#ナビゲーションボタン)
    - [その他のボタン](#その他のボタン)
- [ダイアログ内ボタンの制御](#ダイアログ内ボタンの制御)
- [ショートカットキーの変更・追加方法](#ショートカットキーの変更追加方法)
    - [標準機能での変更](#標準機能での変更)
    - [サーバースクリプトによるボタン制御](#サーバースクリプトによるボタン制御)
    - [ExtendedScripts（JavaScript）による変更](#extendedscriptsjavascriptによる変更)
- [関連ソースコード](#関連ソースコード)
- [結論](#結論)
    - [注意事項](#注意事項)
- [関連リンク](#関連リンク)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 調査情報

| 調査日        | リポジトリ | ブランチ           | タグ/バージョン | コミット    | 備考     |
| ------------- | ---------- | ------------------ | --------------- | ----------- | -------- |
| 2026年2月19日 | Pleasanter | Pleasanter_1.5.1.0 |                 | `34f162a43` | 初回調査 |

## 調査目的

- プリザンターで使用可能なショートカットキーの一覧を把握する
- ショートカットキーの実装方法を理解する
- ショートカットキーの変更・追加方法を調査する

---

## ショートカットキーの実装方式

### HTML accesskey 属性の使用

プリザンターのショートカットキーは、**HTML標準仕様（HTML Living Standard）** で定義されている`accesskey`グローバル属性を使用して実装されている。

**特徴:**

- ブラウザがネイティブでサポートしている機能
- JavaScriptライブラリやフレームワークは使用していない
- **DOM操作後にイベントをバインドする必要がない**（ブラウザが自動的に処理）

```html
<!-- 生成されるHTMLの例 -->
<button id="UpdateCommand" accesskey="s" class="button button-icon">更新</button>
```

ExtendedScriptsで要素を追加・変更する場合も、`accesskey`属性を設定するだけでショートカットキーが有効になる。

```javascript
// イベントバインド不要 - 属性を設定するだけで動作する
$('#CustomButton').attr('accesskey', 'g');
```

**サーバーサイドでの実装:**

```csharp
// HtmlControls.cs (755-786行目)
public static HtmlBuilder Button(
    this HtmlBuilder hb,
    string controlId = null,
    string text = null,
    string accessKey = null,  // ショートカットキーを指定
    // ...省略
    bool _using = true)
{
    return _using
        ? hb.Button(
            attributes: new HtmlAttributes()
                .Id(controlId)
                .Class("button " + controlCss)
                .AccessKey(accessKey)  // accesskey属性を設定
                // ...省略
```

### HtmlAttributes.AccessKey メソッド

```csharp
// HtmlAttributes.cs (270-278行目)
public HtmlAttributes AccessKey(string value, bool _using = true)
{
    if (!value.IsNullOrEmpty() && _using)
    {
        Add("accesskey");
        Add(value);
    }
    return this;
}
```

### ブラウザでのショートカットキー使用方法

`accesskey`属性を使用したショートカットキーは、ブラウザ・OSによって修飾キーが異なる。

| OS/ブラウザ   | 修飾キー              | 例（accesskey="s"の場合） |
| ------------- | --------------------- | ------------------------- |
| Windows/Linux | `Alt + Shift + key`   | `Alt + Shift + S`         |
| macOS Chrome  | `Control + Alt + key` | `Control + Alt + S`       |
| macOS Safari  | `Control + Alt + key` | `Control + Alt + S`       |
| macOS Firefox | `Control + Alt + key` | `Control + Alt + S`       |

---

## 使用可能なショートカットキー一覧

### コマンドボタン

主に編集画面や一覧画面で使用されるコマンドボタンのショートカットキー。

| キー | コントロールID                      | 機能           | 使用場面       | 実装ファイル        |
| :--: | ----------------------------------- | -------------- | -------------- | ------------------- |
| `q`  | GoBack                              | 戻る           | 編集画面       | HtmlCommands.cs:50  |
| `s`  | CreateCommand                       | 作成           | 新規作成画面   | HtmlCommands.cs:78  |
| `s`  | UpdateCommand                       | 更新           | 編集画面       | HtmlCommands.cs:525 |
| `s`  | UpdateByGridCommand                 | 一覧更新       | 一覧編集モード | HtmlCommands.cs:319 |
| `s`  | UpdateDashboardPartLayouts          | レイアウト保存 | ダッシュボード | HtmlCommands.cs:291 |
| `s`  | OpenBulkUpdateSelectorDialogCommand | 一括更新       | 一覧画面       | HtmlCommands.cs:419 |
| `r`  | DeleteCommand                       | 削除           | 編集画面       | HtmlCommands.cs:596 |
| `r`  | OpenDeleteSiteDialogCommand         | サイト削除     | サイト編集画面 | HtmlCommands.cs:612 |
| `r`  | BulkDeleteCommand                   | 一括削除       | 一覧画面       | HtmlCommands.cs:374 |
| `c`  | OpenCopyDialogCommand               | コピー         | 編集画面       | HtmlCommands.cs:539 |
| `k`  | ReferenceCopyCommand                | 参照コピー     | 編集画面       | HtmlCommands.cs:552 |
| `o`  | MoveTargetsCommand                  | 移動           | 編集画面       | HtmlCommands.cs:565 |
| `o`  | BulkMoveTargetsCommand              | 一括移動       | 一覧画面       | HtmlCommands.cs:356 |
| `m`  | EditOutgoingMail                    | メール送信     | 編集画面       | HtmlCommands.cs:587 |
| `w`  | EditImportSettings                  | インポート     | 一覧画面       | HtmlCommands.cs:390 |
| `x`  | OpenExportSelectorDialogCommand     | エクスポート   | 一覧画面       | HtmlCommands.cs:403 |

### ナビゲーションボタン

レコード間の移動やカレンダー・ガントチャートのナビゲーション。

| キー | コントロールID | 機能     | 使用場面       | 実装ファイル              |
| :--: | -------------- | -------- | -------------- | ------------------------- |
| `b`  | Previous       | 前へ     | レコード切替   | HtmlRecordSwitchers.cs:40 |
| `n`  | Next           | 次へ     | レコード切替   | HtmlRecordSwitchers.cs:50 |
| `b`  | -              | 前の期間 | カレンダー     | HtmlCalendar.cs:97        |
| `n`  | -              | 次の期間 | カレンダー     | HtmlCalendar.cs:103       |
| `b`  | -              | 前の期間 | ガントチャート | HtmlGantt.cs:68           |
| `n`  | -              | 次の期間 | ガントチャート | HtmlGantt.cs:75           |
| `b`  | -              | 前の期間 | クロス集計     | HtmlCrosstab.cs:108       |
| `n`  | -              | 次の期間 | クロス集計     | HtmlCrosstab.cs:115       |

### その他のボタン

| キー | コントロールID | 機能 | 使用場面                 | 実装ファイル          |
| :--: | -------------- | ---- | ------------------------ | --------------------- |
| `q`  | -              | 戻る | サイト設定               | SiteUtilities.cs:2588 |
| `s`  | -              | 保存 | 一括更新ダイアログ       | HtmlBulkUpdate.cs:43  |
| `s`  | -              | 保存 | エディタ（編集モーダル） | HtmlEditor.cs:55      |

---

## ダイアログ内ボタンの制御

`accesskey`属性を持つボタンがダイアログの外側にある場合、そのショートカットキーは無効化される。

```javascript
// _form.js (32-44行目)
$p.outsideDialog = function ($control) {
    if (!$control.attr('accesskey')) {
        return false;
    }
    var dialogs = $('.ui-dialog:visible').map(function (i, e) {
        return $('#' + e.getAttribute('aria-describedby'));
    });
    return (
        dialogs.length !== 0 &&
        dialogs.filter(function (i, e) {
            return $control.closest(e).length === 1;
        }).length === 0
    );
};
```

---

## ショートカットキーの変更・追加方法

### 標準機能での変更

**プリザンター標準機能として、ショートカットキー（accesskey）を直接変更する設定は提供されていない。**

ただし、サーバースクリプトを使用してボタンの表示状態を制御することは可能。

### サーバースクリプトによるボタン制御

サーバースクリプトの`elements`オブジェクトを使用して、ボタンの表示/非表示/無効化を制御できる。

#### CommandDisplayTypes の値

```csharp
// View.cs (29-35行目)
public enum CommandDisplayTypes : int
{
    Displayed = 0,
    None = 1,      // ボタンを非表示
    Disabled = 2,  // ボタンを無効化
    Hidden = 3,    // ボタンを非表示（style="display:none"）
}
```

#### サーバースクリプトでの使用例

```javascript
// ボタンを非表示にする（accesskeyも無効になる）
elements.DisplayType('UpdateCommand', 1); // None

// ボタンを無効化する（accesskeyは残るが動作しない）
elements.DisplayType('DeleteCommand', 2); // Disabled

// ボタンを非表示にする（Hidden）
elements.DisplayType('OpenCopyDialogCommand', 3); // Hidden

// ボタンのラベルテキストを変更する
elements.LabelText('UpdateCommand', '保存して閉じる');
```

#### 制御可能なコントロールID一覧

| コントロールID                      | 機能             |
| ----------------------------------- | ---------------- |
| CreateCommand                       | 作成ボタン       |
| UpdateCommand                       | 更新ボタン       |
| DeleteCommand                       | 削除ボタン       |
| OpenCopyDialogCommand               | コピーダイアログ |
| ReferenceCopyCommand                | 参照コピー       |
| MoveTargetsCommand                  | 移動             |
| EditOutgoingMail                    | メール送信       |
| BulkDeleteCommand                   | 一括削除         |
| BulkMoveTargetsCommand              | 一括移動         |
| EditImportSettings                  | インポート       |
| OpenExportSelectorDialogCommand     | エクスポート     |
| OpenBulkUpdateSelectorDialogCommand | 一括更新         |
| EditOnGridCommand                   | 一覧編集モード   |
| UpdateByGridCommand                 | 一覧更新         |
| GoBack                              | 戻る             |

### ExtendedScripts（JavaScript）による変更

クライアントサイドのJavaScriptで`accesskey`属性を直接操作することで、ショートカットキーを変更できる。

#### accesskey の変更例

```javascript
// 更新ボタンのショートカットキーを「u」に変更
$('#UpdateCommand').attr('accesskey', 'u');

// 削除ボタンのショートカットキーを削除（無効化）
$('#DeleteCommand').removeAttr('accesskey');

// 戻るボタンのショートカットキーを「b」に変更
$('#GoBack').attr('accesskey', 'b');
```

#### 新規ショートカットキーの追加例

```javascript
// 既存のボタンに新しいショートカットキーを追加
$('#Reload').attr('accesskey', 'e'); // 再読み込みに「e」を割り当て

// カスタムボタンを作成してショートカットキーを設定
$('#MainCommands').append(
    $('<button>')
        .attr('id', 'CustomButton')
        .attr('accesskey', 'g')
        .addClass('button button-icon button-positive')
        .text('カスタム処理')
        .on('click', function () {
            // カスタム処理
        })
);
```

#### accesskey 重複時の動作

同じ`accesskey`が複数の要素に設定された場合の動作は、ブラウザによって異なる。

| ブラウザ    | 重複時の動作                                              |
| ----------- | --------------------------------------------------------- |
| Chrome/Edge | DOM順で**最初**の要素にフォーカスが移動する               |
| Firefox     | 同じaccesskeyを持つ要素間を**順番に切り替える**（トグル） |
| Safari      | DOM順で**最初**の要素にフォーカスが移動する               |

**ExtendedScriptsで追加した場合の優先順位:**

```javascript
// ケース1: 既存のボタンのaccesskeyを変更する場合
// → 単純に上書きされ、新しいキーが有効になる
$('#UpdateCommand').attr('accesskey', 'u'); // s → u に変更

// ケース2: 新しい要素に既存と同じaccesskeyを設定する場合
// → 既存のボタンが優先される（Chrome/Safari）
// → Firefoxでは両方の要素間を切り替え可能
$('#CustomButton').attr('accesskey', 's'); // 既存のUpdateCommandと重複
```

| シナリオ                                | Chrome/Edge/Safari | Firefox                |
| --------------------------------------- | ------------------ | ---------------------- |
| 既存要素のaccesskeyを変更               | 新しいキーが有効   | 新しいキーが有効       |
| 新規要素に既存と同じキーを設定          | **既存要素が優先** | 両方に順番にフォーカス |
| 既存要素のaccesskeyを削除して新規に設定 | 新規要素が有効     | 新規要素が有効         |

**推奨される実装パターン:**

```javascript
// 重複を避けるため、既存のaccesskeyを削除してから新しい要素に設定
$('#UpdateCommand').removeAttr('accesskey'); // 既存のaccesskeyを削除
$('#CustomButton').attr('accesskey', 's'); // 新しい要素に設定
```

#### keydownイベントによるカスタムショートカットの実装

HTMLの`accesskey`属性を使用せず、キーボードイベントを直接ハンドルすることで、より柔軟なショートカットキーを実装できる。

```javascript
$(document).on('keydown', function (e) {
    // Ctrl + Enter で更新
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        $('#UpdateCommand').click();
    }

    // Escape で戻る
    if (e.key === 'Escape' && !$('.ui-dialog:visible').length) {
        e.preventDefault();
        $p.back();
    }

    // Ctrl + Shift + D で削除
    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        $('#DeleteCommand').click();
    }
});
```

---

## 関連ソースコード

| ファイル                | パス                                                                | 説明                           |
| ----------------------- | ------------------------------------------------------------------- | ------------------------------ |
| HtmlCommands.cs         | Implem.Pleasanter/Libraries/HtmlParts/HtmlCommands.cs               | コマンドボタンの生成           |
| HtmlControls.cs         | Implem.Pleasanter/Libraries/HtmlParts/HtmlControls.cs               | ボタンコントロールの生成       |
| HtmlAttributes.cs       | Implem.Pleasanter/Libraries/Html/HtmlAttributes.cs                  | HTML属性の設定                 |
| HtmlRecordSwitchers.cs  | Implem.Pleasanter/Libraries/HtmlParts/HtmlRecordSwitchers.cs        | レコード切替ボタン             |
| HtmlCalendar.cs         | Implem.Pleasanter/Libraries/HtmlParts/HtmlCalendar.cs               | カレンダーナビゲーション       |
| HtmlGantt.cs            | Implem.Pleasanter/Libraries/HtmlParts/HtmlGantt.cs                  | ガントチャートナビゲーション   |
| HtmlCrosstab.cs         | Implem.Pleasanter/Libraries/HtmlParts/HtmlCrosstab.cs               | クロス集計ナビゲーション       |
| \_form.js               | Implem.PleasanterFrontend/wwwroot/src/scripts/generals/\_form.js    | フォーム関連のクライアント処理 |
| keyevents.js            | Implem.PleasanterFrontend/wwwroot/src/scripts/generals/keyevents.js | キーイベント処理               |
| ServerScriptElements.cs | Implem.Pleasanter/Libraries/ServerScripts/ServerScriptElements.cs   | サーバースクリプト要素制御     |
| View.cs                 | Implem.Pleasanter/Libraries/Settings/View.cs                        | CommandDisplayTypes定義        |

---

## 結論

| 項目                         | 内容                                                                  |
| ---------------------------- | --------------------------------------------------------------------- |
| 実装方式                     | HTMLの`accesskey`属性を使用                                           |
| 主要なキー                   | `s`(保存/更新)、`r`(削除)、`q`(戻る)、`c`(コピー)、`b`/`n`(前/次)     |
| 標準設定での変更             | **不可** - accesskeyを変更するパラメータは提供されていない            |
| サーバースクリプトでの制御   | `elements.DisplayType()`でボタンの表示/非表示/無効化が可能            |
| ExtendedScriptsでの変更      | JavaScriptで`accesskey`属性を直接操作することで変更可能               |
| カスタムショートカットの追加 | `keydown`イベントをハンドルすることでカスタムショートカットを実装可能 |

### 注意事項

- `accesskey`属性によるショートカットキーは、ブラウザ/OSによって修飾キーが異なる
- ダイアログが表示されている場合、ダイアログ外のボタンのショートカットキーは無効化される
- 同じキーが複数のボタンに設定されている場合（例：`b`がPreviousとカレンダーの両方）、コンテキストによって動作が異なる可能性がある

---

## 関連リンク

- [HTML accesskey グローバル属性 - MDN Web Docs](https://developer.mozilla.org/ja/docs/Web/HTML/Global_attributes/accesskey)
